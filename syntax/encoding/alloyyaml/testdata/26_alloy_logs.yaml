discovery.kubernetes/pods:
    role: pod
    selectors:
        field: expr("spec.nodeName=" + coalesce(sys.env("HOSTNAME"), constants.hostname))
        role: pod
discovery.relabel/default:
    rule:
        - action: drop
          regex: ""
          source_labels:
            - __service__
        - source_labels:
            - __meta_kubernetes_pod_node_name
          target_label: __host__
        - action: labelmap
          regex: __meta_kubernetes_pod_label_(.+)
        - separator: /
          source_labels:
            - __meta_kubernetes_namespace
            - __service__
          target_label: job
        - source_labels:
            - __meta_kubernetes_namespace
          target_label: namespace
        - source_labels:
            - __meta_kubernetes_pod_name
          target_label: pod
        - source_labels:
            - __meta_kubernetes_pod_container_name
          target_label: container
        - replacement: /var/log/pods/*$1/*.log
          separator: /
          source_labels:
            - __meta_kubernetes_pod_uid
            - __meta_kubernetes_pod_container_name
          target_label: __path__
    targets: |-
        expr(array.concat(
        	discovery.relabel.pods_name.output,
        	discovery.relabel.pods_app.output,
        	discovery.relabel.pods_static.output,
        	discovery.relabel.pods_direct_controllers.output,
        	discovery.relabel.pods_indirect_controllers.output,
        ))
discovery.relabel/pods_app:
    rule:
        - action: drop
          regex: .+
          source_labels:
            - __meta_kubernetes_pod_label_name
        - source_labels:
            - __meta_kubernetes_pod_label_app
          target_label: __service__
    targets: expr(discovery.kubernetes.pods.targets)
discovery.relabel/pods_direct_controllers:
    rule:
        - action: drop
          regex: .+
          separator: ""
          source_labels:
            - __meta_kubernetes_pod_label_name
            - __meta_kubernetes_pod_label_app
        - action: drop
          regex: '[0-9a-z-.]+-[0-9a-f]{8,10}'
          source_labels:
            - __meta_kubernetes_pod_controller_name
        - source_labels:
            - __meta_kubernetes_pod_controller_name
          target_label: __service__
    targets: expr(discovery.kubernetes.pods.targets)
discovery.relabel/pods_indirect_controllers:
    rule:
        - action: drop
          regex: .+
          separator: ""
          source_labels:
            - __meta_kubernetes_pod_label_name
            - __meta_kubernetes_pod_label_app
        - action: keep
          regex: '[0-9a-z-.]+-[0-9a-f]{8,10}'
          source_labels:
            - __meta_kubernetes_pod_controller_name
        - regex: ([0-9a-z-.]+)-[0-9a-f]{8,10}
          source_labels:
            - __meta_kubernetes_pod_controller_name
          target_label: __service__
    targets: expr(discovery.kubernetes.pods.targets)
discovery.relabel/pods_name:
    rule:
        source_labels:
            - __meta_kubernetes_pod_label_name
        target_label: __service__
    targets: expr(discovery.kubernetes.pods.targets)
discovery.relabel/pods_static:
    rule:
        - action: drop
          regex: ""
          source_labels:
            - __meta_kubernetes_pod_annotation_kubernetes_io_config_mirror
        - source_labels:
            - __meta_kubernetes_pod_annotation_kubernetes_io_config_mirror
          target_label: __meta_kubernetes_pod_uid
        - source_labels:
            - __meta_kubernetes_pod_label_component
          target_label: __service__
    targets: expr(discovery.kubernetes.pods.targets)
discovery.relabel/systemd_journal:
    rule:
        - source_labels:
            - __journal__hostname
          target_label: nodename
        - source_labels:
            - __journal_syslog_identifier
          target_label: syslog_identifier
        - source_labels:
            - __journal_priority_keyword
          target_label: priority
    targets:
        $array: []
livedebugging:
    enabled: true
loki.process/logs:
    forward_to:
        - expr(loki.write.logs.receiver)
    stage.cri:
        max_partial_line_size: 262142
        max_partial_line_size_truncate: true
    stage.drop:
        - longer_than: 262142B
        - drop_counter_reason: noisy_logs_from_querier
          expression: caching_index_client.go:308.*caching index entries
    stage.label_drop:
        values:
            - filename
    stage.labels:
        values:
            $object:
                debug: ""
    stage.match:
        - action: drop
          selector: '{job=~"loki-.*/ingester.*"} |= "metrics.go"'
        - selector: '{container="ingress-nginx"} |= "hosted-grafana-"'
          stage.labels:
            values:
                $object:
                    service: ""
          stage.template:
            source: service
            template: hosted-grafana
        - selector: '{name="eventrouter"}'
          stage.json:
            expressions:
                $object:
                    component: event.source.component
                    host: event.source.host
                    message: event.message
                    namespace: event.metadata.namespace
                    object_kind: event.involvedObject.kind
                    object_name: event.involvedObject.name
                    reason: event.reason
                    type: event.type
          stage.labels:
            values:
                $object:
                    namespace: ""
          stage.output:
            source: newoutput
          stage.template:
            source: newoutput
            template: test
        - selector: '{name="kube-diff-logger"}'
          stage.json:
            expressions:
                $object:
                    timestamp: timestamp
          stage.timestamp:
            format: RFC3339
            source: timestamp
        - selector: '{container="loki-canary",stream="stdout"}'
          stage.regex:
            expression: (?P<ts>\d+) p+
          stage.timestamp:
            action_on_failure: skip
            format: UnixNs
            source: ts
        - selector: '{name="amixr-engine"}'
          stage.multiline:
            firstline: ^\d{4}-\d{2}-\d{2} \d{1,2}:\d{2}:\d{2}
        - selector: '{name=~"amixr-engine-celery-.*"}'
          stage.multiline:
            firstline: ^\d{4}-\d{2}-\d{2} \d{1,2}:\d{2}:\d{2}
        - selector: '{container="cortex-gw"} |= "agent id"'
          stage.static_labels:
            values:
                $object:
                    agent_log: id
        - selector: '{container="cortex-gw"} |= "sample remote write"'
          stage.static_labels:
            values:
                $object:
                    agent_log: write
        - selector: '{namespace=~".*(alertmanager|amixr|cortex|fire|ge-metrics|grafana|loki|mimir|tempo).*"} |~ "(insight_logs|insight|insights)=true"'
          stage.static_labels:
            values:
                $object:
                    insight: "true"
        - selector: '{namespace="asserts", container=~"api-server|assertion-detector|model-builder"}'
          stage.labels:
            values:
                $object:
                    level: log_level
                    loggerName: logger_name
                    tenantId: tenant_id
                    threadName: thread_name
          stage.multiline:
            firstline: ^[A-Z]{4,5}[ ]{1,2}\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3}
          stage.regex:
            expression: ^(?P<log_level>\S+)\s+\S+\s+\S+\s+(?P<thread_name>\S+)\s+(?P<logger_name>\S+)(\s+)?(?:.*tenantId=(?P<tenant_id>\d+))?
        - selector: '{namespace=~".*(grafana|loki|cortex|mimir|tempo|pyroscope|phlare|fire|profiles|ge-logs|ge-metrics|ge-traces|promtail|machine-learning|agent|amixir|asserts|chatops|faro|incident).*"}'
          stage.labels:
            values:
                $object:
                    service_name: ""
          stage.regex:
            expression: .*(?P<team>grafana|loki|cortex|mimir|tempo|pyroscope|phlare|fire|profiles|ge-logs|ge-metrics|ge-traces|promtail|machine-learning|agent|amixir|asserts|chatops|faro|incident).*
            source: namespace
          stage.template:
            - source: team
              template: loki
            - source: service_name
              template: loki/container
        - selector: '{namespace="machine-learning",container=~"modelapi|worker"}'
          stage.multiline:
            firstline: ^({"text|\[\d{4})
        - selector: '{name=~"hosted-grafana-api|grafana"}'
          stage.labels:
            values:
                $object:
                    instance_audit: ""
          stage.logfmt:
            mapping:
                $object:
                    instance_audit: ""
        - selector: '{namespace="securityops",job="securityops/cloudtrail-exporter-workloads-prod"}'
          stage.json:
            expressions:
                $object:
                    eventCategory: event.eventCategory
                    eventName: event.eventName
                    eventSource: event.eventSource
                    timestamp: time
          stage.labels:
            values:
                $object:
                    eventCategory: ""
                    eventName: ""
                    eventSource: ""
          stage.structured_metadata:
            values:
                $object:
                    container: ""
                    pod: ""
                    pod_template_hash: ""
                    stream: ""
          stage.timestamp:
            format: RFC3339
            source: timestamp
        - selector: '{namespace="securityops",job="securityops/cloudtrail-exporter-workloads-ops"}'
          stage.json:
            expressions:
                $object:
                    eventCategory: event.eventCategory
                    eventName: event.eventName
                    eventSource: event.eventSource
                    timestamp: time
          stage.labels:
            values:
                $object:
                    eventCategory: ""
                    eventName: ""
                    eventSource: ""
          stage.structured_metadata:
            values:
                $object:
                    container: ""
                    pod: ""
                    pod_template_hash: ""
                    stream: ""
          stage.timestamp:
            format: RFC3339
            source: timestamp
        - selector: '{namespace="securityops",job="securityops/cloudtrail-exporter-workloads-dev"}'
          stage.json:
            expressions:
                $object:
                    eventCategory: event.eventCategory
                    eventName: event.eventName
                    eventSource: event.eventSource
                    timestamp: time
          stage.labels:
            values:
                $object:
                    eventCategory: ""
                    eventName: ""
                    eventSource: ""
          stage.structured_metadata:
            values:
                $object:
                    container: ""
                    pod: ""
                    pod_template_hash: ""
                    stream: ""
          stage.timestamp:
            format: RFC3339
            source: timestamp
        - selector: '{namespace="securityops",job="securityops/gh-audit-logs"}'
          stage.json:
            expressions:
                $object:
                    action: event.action
                    actorIsBot: event.actor_is_bot
                    eventType: event.event
                    operationType: event.operation_type
                    repo: event.repo
                    repoId: event.repo_id
                    timestamp: time
          stage.labels:
            values:
                $object:
                    action: ""
                    actorIsBot: ""
                    eventType: ""
                    operationType: ""
                    repo: ""
                    repoId: ""
          stage.structured_metadata:
            values:
                $object:
                    container: ""
                    pod: ""
                    pod_template_hash: ""
                    stream: ""
          stage.timestamp:
            format: RFC3339
            source: timestamp
        - selector: '{job="notification-historian/notification-historian"}'
          stage.json:
            expressions:
                $object:
                    alerts: alerts
                    commonAnnotations: commonAnnotations
                    commonLabels: commonLabels
                    externalURL: externalURL
                    groupKey: groupKey
                    groupLabels: groupLabels
                    level: level
                    message: message
                    orgID: orgID
                    receiver: receiver
                    state: state
                    status: status
                    timestamp: time
                    title: title
                    truncatedAlerts: truncatedAlerts
                    version: version
          stage.labels:
            values:
                $object:
                    alertname: ""
                    level: ""
                    orgID: ""
                    receiver: ""
                    state: ""
                    status: ""
          stage.structured_metadata:
            values:
                $object:
                    alerts: ""
                    commonAnnotations: ""
                    commonLabels: ""
                    container: ""
                    externalURL: ""
                    groupKey: ""
                    groupLabels: ""
                    message: ""
                    pod: ""
                    pod_template_hash: ""
                    stream: ""
                    title: ""
                    truncatedAlerts: ""
                    version: ""
          stage.timestamp:
            format: RFC3339
            source: timestamp
        - selector: '{job="default/tetragon"}'
          stage.json:
            expressions:
                $object:
                    processExecArguments: process_exec.process.arguments
                    processExecBinary: process_exec.process.binary
                    processExecPodNamespace: process_exec.process.pod.namespace
          stage.label_drop:
            values:
                - pod
                - container
                - stream
          stage.labels:
            values:
                $object:
                    processExecPodNamespace: ""
          stage.structured_metadata:
            values:
                $object:
                    processExecArguments: ""
                    processExecBinary: ""
        - selector: '{name="okta-logs"}'
          stage.json:
            expressions:
                $object:
                    alternateId: event.actor.alternateId
                    eventType: event.eventType
                    ipAddress: event.client.ipAddress
                    level: event.severity
                    timestamp: time
          stage.label_drop:
            values:
                - pod
                - pod_template_hash
                - container
                - stream
          stage.labels:
            values:
                $object:
                    eventType: ""
                    level: ""
          stage.structured_metadata:
            values:
                $object:
                    alternateId: ""
                    container: ""
                    ipAddress: ""
                    pod: ""
                    pod_template_hash: ""
                    stream: ""
          stage.timestamp:
            format: RFC3339
            source: timestamp
        - selector: '{namespace="hosted-grafana", app="grafana"}'
          stage.label_drop:
            values:
                - pod
                - resource_version
                - pod_template_hash
          stage.structured_metadata:
            values:
                $object:
                    pod: ""
                    pod_template_hash: ""
                    resource_version: ""
        - selector: '{namespace=~"loki.*"}'
          stage.label_drop:
            values:
                - pod
                - pod_template_hash
                - controller_revision_hash
          stage.structured_metadata:
            values:
                $object:
                    controller_revision_hash: ""
                    pod: ""
                    pod_template_hash: ""
        - selector: '{namespace=~"(loki-live|loki-dev-.*|loki-prod.*|loki-ops.*)", container!~"memcached|static-exporter|archiver-operator|cortex-gw|eventrouter|loki-canary|rollout-operator"}'
          stage.logfmt:
            mapping:
                $object:
                    org_id: ""
                    orgID: ""
                    traceID: ""
                    user_id: ""
          stage.structured_metadata:
            values:
                $object:
                    org_id: ""
                    orgID: ""
                    traceID: ""
                    user_id: ""
        - selector: '{job=~"cicd-o11y/grafana-.*"} |= "service=bench"'
          stage.static_labels:
            values:
                $object:
                    bench: "true"
        - selector: '{namespace="hosted-grafana-cd"} |= "service=bench"'
          stage.static_labels:
            values:
                $object:
                    bench: "true"
    stage.metrics:
        - metric.counter:
            - action: add
              count_entry_bytes: true
              description: A running counter of all bytes per stream with their corresponding labels
              match_all: true
              name: byte_count_total
              prefix: promtail_custom_
            - action: inc
              description: A running counter of all lines with their corresponding labels
              match_all: true
              name: line_count_total
              prefix: promtail_custom_
        - metric.counter:
            - action: inc
              description: total count of bad words found in log lines
              name: bad_words_total
              prefix: promtail_custom_
              source: bad_words
            - action: inc
              description: 'total count of panic: found in log lines'
              name: panic_total
              prefix: promtail_custom_
              source: panic
    stage.regex:
        - expression: (level|lvl|severity)=(?P<debug>debug)
        - expression: (?P<panic>panic:)
        - expression: (?i)(?P<bad_words>panic:|core_dumped|failure|error|attack| bad |illegal |denied|refused|unauthorized|fatal|failed|Segmentation Fault|Corrupted)
    stage.template:
        source: debug
        template: "true"
loki.source.file/logs:
    file_match:
        enabled: true
    forward_to:
        - expr(loki.process.logs.receiver)
    targets: expr(discovery.relabel.default.output)
loki.source.journal/logs_default_systemd_journal:
    forward_to:
        - expr(loki.write.logs.receiver)
    labels:
        $object:
            job: default/systemd-journal
    path: /var/log/journal
    relabel_rules: expr(discovery.relabel.systemd_journal.rules)
loki.write/logs:
    endpoint:
        basic_auth:
            password: expr(sys.env("API_KEY"))
            username: expr(sys.env("TENANT_ID"))
        url: https://logs-us-central1.grafana.net/loki/api/v1/push
    external_labels:
        $object:
            cluster: expr(sys.env("CLUSTER_NAME"))
