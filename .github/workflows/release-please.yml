name: Release Please

on:
  push:
    branches:
      - main
      - 'release/v*'

permissions:
  contents: write
  pull-requests: write
  id-token: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    steps:
      - name: Get GitHub app secrets ðŸ”
        id: get-secrets
        uses: grafana/shared-workflows/actions/get-vault-secrets@a37de51f3d713a30a9e4b21bcdfbd38170020593 # get-vault-secrets/v1.3.0
        with:
          export_env: false
          repo_secrets: |
            ALLOYBOT_APP_ID=alloybot:app_id
            ALLOYBOT_PRIVATE_KEY=alloybot:private_key

      - name: Generate token ðŸ”
        uses: actions/create-github-app-token@29824e69f54612133e76f7eaac726eef6c875baf # v2.2.1
        id: app-token
        with:
          app-id: ${{ fromJSON(steps.get-secrets.outputs.secrets).ALLOYBOT_APP_ID }}
          private-key: ${{ fromJSON(steps.get-secrets.outputs.secrets).ALLOYBOT_PRIVATE_KEY }}
          owner: grafana
          repositories: alloy

      - name: Checkout repository ðŸ›Žï¸
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6
        with:
          persist-credentials: false

      - name: Setup Node.js ðŸ—ï¸
        uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4
        with:
          node-version-file: tools/release/release-please-runner/.nvmrc
          package-manager-cache: false

      - name: Install dependencies ðŸ“¦
        working-directory: tools/release/release-please-runner
        run: npm install

      - name: Set main branch overrides ðŸ”§
        if: github.ref_name == 'main'
        run: |
          echo "SKIP_GITHUB_RELEASE=true" >> $GITHUB_ENV
          echo "PULL_REQUEST_TITLE=Unreleased Changes" >> $GITHUB_ENV
          {
            echo "PULL_REQUEST_HEADER<<EOF"
            echo 'ðŸš« **DO NOT MERGE - This PR is for tracking purposes only**'
            echo ''
            echo 'This draft PR tracks the changes that will be included in the next minor release. It updates automatically with each push to main.'
            echo ''
            echo 'When ready to cut a release:'
            echo '1. Create a release branch (e.g., `release/v1.13`)'
            echo '2. The release-please automation will take over on that branch'
            echo '3. This PR will remain on main to track the next release'
            echo ''
            echo '---'
            echo "EOF"
          } >> $GITHUB_ENV

      - name: Run release-please ðŸš€
        working-directory: tools/release/release-please-runner
        env:
          GITHUB_TOKEN: ${{ steps.app-token.outputs.token }}
          REPO_URL: ${{ github.repository }}
          TARGET_BRANCH: ${{ github.ref_name }}
          CONFIG_FILE: release-please-config.json
          MANIFEST_FILE: .release-please-manifest.json
          SKIP_GITHUB_RELEASE: ${{ env.SKIP_GITHUB_RELEASE }}
          PULL_REQUEST_TITLE: ${{ env.PULL_REQUEST_TITLE }}
          PULL_REQUEST_HEADER: ${{ env.PULL_REQUEST_HEADER }}
        run: node index.js
