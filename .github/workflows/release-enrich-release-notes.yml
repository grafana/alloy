name: Enrich Release Notes with Contributors

on:
  release:
    types: [published]

permissions:
  contents: write
  id-token: write

jobs:
  enrich-release:
    runs-on: ubuntu-latest
    steps:
      - name: Get GitHub app secrets üîê
        id: get-secrets
        uses: grafana/shared-workflows/actions/get-vault-secrets@a37de51f3d713a30a9e4b21bcdfbd38170020593 # get-vault-secrets/v1.3.0
        with:
          export_env: false
          repo_secrets: |
            ALLOYBOT_APP_ID=alloybot:app_id
            ALLOYBOT_PRIVATE_KEY=alloybot:private_key

      - name: Generate token üîê
        uses: actions/create-github-app-token@d72941d797fd3113feb6b93fd0dec494b13a2547 # v1.12.0
        id: app-token
        with:
          app-id: ${{ fromJSON(steps.get-secrets.outputs.secrets).ALLOYBOT_APP_ID }}
          private-key: ${{ fromJSON(steps.get-secrets.outputs.secrets).ALLOYBOT_PRIVATE_KEY }}
          owner: grafana
          repositories: alloy

      - name: Enrich release notes with contributors üôã
        uses: actions/github-script@v7
        with:
          github-token: ${{ steps.app-token.outputs.token }}
          script: |
            const release = context.payload.release;
            const releaseBody = release.body || '';
            const lines = releaseBody.split('\n');
            let newReleaseBody = releaseBody;

            for (const line of lines) {
              const prMatch = line.match(/\[#(\d+)\]\([^)]+\)/);
              if (!prMatch) continue;

              const prNumber = Number.parseInt(prMatch[1], 10);
              const { data: pr } = await github.rest.pulls.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: prNumber
              });
              const username = pr.user.login;

              console.log(`PR #${prNumber} authored by @${username}`);
              newReleaseBody = newReleaseBody.replace(line, `${line} (@${username})`);
            }

            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: release.id,
              body: newReleaseBody
            });

            console.log('Release notes updated successfully with contributor information');
