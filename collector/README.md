# Alloy Collector Distro

This directory contains the build configuration and generated code for the **Alloy Collector Distro**, an OpenTelemetry Collector distribution that embeds Alloy's OTel components and integrates with the Alloy CLI. This also means that it contains the generated build root of the Alloy project.

## Overview

The Alloy Collector Distro is generated using the [OpenTelemetry Collector Builder (OCB)](https://github.com/open-telemetry/opentelemetry-collector-builder) tool. Components are defined in an OCB configuration file, and the build process generates the necessary Go code, including the `main.go` file and `go.mod` dependencies. Post processing is then performed on the generated files to tie both the OTel and Default engines together and expose them in a single executable. For details on how this is done, see the [generate-otel-engine-collector tool](../tools/generate-otel-engine-collector/README.md).

## Directory Structure

```
collector/
├── builder-config.yaml        # OCB configuration file (source)
├── version.go                 # Exposes the current version of the collector distro (source)
├── main.go                    # Generated by OCB, post-processed by tools/generate-otel-engine-collector (DO NOT EDIT)
├── main_alloy.go              # Generated by tools/generate-otel-engine-collector (DO NOT EDIT)
├── main_others.go             # Generated by OCB (DO NOT EDIT)
├── main_windows.go            # Generated by OCB (DO NOT EDIT)
├── components.go              # Generated by OCB (DO NOT EDIT)
├── go.mod                     # Generated by OCB (DO NOT EDIT)
└── go.sum                     # Generated by OCB (DO NOT EDIT)
```

## Notes on Building Locally

`make alloy` runs the code generation described above automatically before building, so you generally don't need to do anything extra. Generation is skipped in CI and when `SKIP_CODE_GENERATION=1` is set.

To regenerate only (without building):

```bash
make generate-otel-collector-distro
```

To build without regenerating:

```bash
SKIP_CODE_GENERATION=1 make alloy
```

## CI Considerations

If your work involves anything that would modify the generated files, please commit them with your changes before pushing to github. We have a github workflow that will check that the output of the collector generation matches what has been checked in, and this will fail if you do not include changes to these files.

## A Note On Replace Directives

The `replaces` section in `builder-config.yaml` must be kept in sync with the replace directives in the root `go.mod` file as well as the `go.mod` file in the alloy engine extension. The Alloy project uses the `dependency-replacements.yaml` file found in the root of the project to generate replace directives. If you modify a replacement, please run `make generate-module-dependencies` to sync things up. There is also a github workflow that will check against this.
