prometheus.exporter.postgres "postgres" {
  data_source_names = ["postgresql://root:rootpassword@postgres:5432/testdb?sslmode=disable"]
}

database_observability.postgres "test" {
  data_source_name = "postgresql://root:rootpassword@postgres:5432/testdb?sslmode=disable"
  forward_to       = [loki.write.default.receiver]
  targets          = prometheus.exporter.postgres.postgres.targets

  query_samples {
    collect_interval = "1s"
  }

  query_details {
    collect_interval = "1s"
  }

  schema_details {
    collect_interval = "1s"
  }

  explain_plans {
    collect_interval = "1s"
  }

  health_check {
    collect_interval = "1s"
  }
}

prometheus.scrape "postgres" {
  targets         = database_observability.postgres.test.targets
  forward_to      = [prometheus.remote_write.default.receiver]
}

prometheus.remote_write "default" {
  endpoint {
    url = "http://mimir:9009/api/v1/push"
  }
  external_labels = {
    test_name = "database_observability_postgres",
  }
}

loki.write "default" {
  endpoint {
    url = "http://loki:3100/loki/api/v1/push"
  }
  external_labels = {
    test_name = "database_observability_postgres",
  }
}
