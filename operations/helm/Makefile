.PHONY: docs rebuild-tests generate-golden-records test-golden-records

CHART_DIR := charts/alloy
GOLDEN_RECORDS_DIR := $(CHART_DIR)/tests/goldenrecords
GOLDEN_RECORD_VALUES := $(GOLDEN_RECORDS_DIR)/*_values.yaml

# Docs generated by https://github.com/norwoodj/helm-docs
docs: charts/alloy/README.md
charts/alloy/README.md: charts/alloy/values.yaml charts/alloy/README.md.gotmpl
	cd charts/alloy && helm-docs

rebuild-tests:
	bash ./scripts/rebuild-tests.sh

generate-golden-records:
	@set -e; \
	for values_file in $(GOLDEN_RECORD_VALUES); do \
		result_file="$${values_file%_values.yaml}_result.yaml"; \
		echo "Generating $$result_file from $$values_file"; \
		helm template test ./$(CHART_DIR) -f "$$values_file" -n test-namespace --kube-version 1.26 --set '$$chart_tests=true' > "$$result_file"; \
	done

test-golden-records:
	@set -e; \
	for values_file in $(GOLDEN_RECORD_VALUES); do \
		result_file="$${values_file%_values.yaml}_result.yaml"; \
		temp_file=$$(mktemp); \
		echo "Verifying $$result_file..."; \
		helm template test ./$(CHART_DIR) -f "$$values_file" -n test-namespace --kube-version 1.26 --set '$$chart_tests=true' > "$$temp_file"; \
		if ! diff -u "$$result_file" "$$temp_file"; then \
			echo "Error: Generated content does not match golden record for $$result_file"; \
			rm "$$temp_file"; \
			exit 1; \
		fi; \
		rm "$$temp_file"; \
	done
	@echo Test completed
