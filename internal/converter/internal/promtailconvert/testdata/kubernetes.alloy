discovery.kubernetes "fun" {
	api_server = "http://toby.pets.com/"
	role       = "pod"

	basic_auth {
		username      = "robin"
		password_file = "/home/robin/.password"
	}
	proxy_url = "http://proxy.example.com"

	tls_config {
		ca_file              = "/home/robin/.ca"
		cert_file            = "/home/robin/.cert"
		key_file             = "/home/robin/.key"
		server_name          = "example.local"
		insecure_skip_verify = true
	}

	selectors {
		role  = "pod"
		field = "spec.nodeName=" + coalesce(sys.env("HOSTNAME"), constants.hostname)
	}
}

discovery.kubernetes "fun_2" {
	role            = "pod"
	kubeconfig_file = "/home/toby/.kube/config"

	selectors {
		role  = "pod"
		field = "spec.nodeName=" + coalesce(sys.env("HOSTNAME"), constants.hostname)
	}
}

discovery.kubernetes "fun_3" {
	api_server = "http://toby.pets.com/"
	role       = "pod"

	authorization {
		type             = "Bearer"
		credentials_file = "/home/robin/.special_token"
	}

	selectors {
		role  = "pod"
		field = "spec.nodeName=" + coalesce(sys.env("HOSTNAME"), constants.hostname)
	}
}

discovery.kubernetes "fun_4" {
	api_server = "http://toby.pets.com/"
	role       = "pod"

	authorization {
		type             = "Bearer"
		credentials_file = "/home/toby/.token"
	}

	selectors {
		role  = "pod"
		field = "spec.nodeName=" + coalesce(sys.env("HOSTNAME"), constants.hostname)
	}
}

discovery.kubernetes "fun_5" {
	api_server = "http://toby.pets.com/"
	role       = "node"

	oauth2 {
		client_id          = "client_id"
		client_secret_file = "foo/bar"
		scopes             = ["scope1", "scope2"]
		token_url          = "https://example/oauth2/token"
		endpoint_params    = {
			host = "example",
			path = "/oauth2/token",
		}

		tls_config { }
	}
	proxy_from_environment = true
}

loki.source.file "fun" {
	targets = array.concat(
		discovery.kubernetes.fun.targets,
		discovery.kubernetes.fun_2.targets,
		discovery.kubernetes.fun_3.targets,
		discovery.kubernetes.fun_4.targets,
		discovery.kubernetes.fun_5.targets,
	)
	forward_to = []

	file_match {
		enabled = true
	}
	legacy_positions_file = "/var/log/positions.yaml"
}
