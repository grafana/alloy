discovery.kubernetes "logs_config_with_metrics" {
	role = "pod"
	selectors {
		role  = "pod"
		field = "spec.nodeName=" + coalesce(sys.env("HOSTNAME"), constants.hostname)
	}
}

loki.process "logs_config_with_metrics" {
	forward_to = [loki.write.logs_config.receiver]

	stage.metrics {
		metric.counter {
			name              = "byte_count_total"
			description       = "A running counter of all bytes per stream with their corresponding labels"
			max_idle_duration = "0s"
			action            = "add"
			match_all         = true
			count_entry_bytes = true
		}
	}
}

loki.source.file "logs_config_with_metrics" {
	targets    = discovery.kubernetes.logs_config_with_metrics.targets
	forward_to = [loki.process.logs_config_with_metrics.receiver]

	file_match {
		enabled = true
	}
	legacy_positions_file = "/path/config.yml"
}

loki.write "logs_config" {
	endpoint {
		url = "http://localhost/loki/api/v1/push"
	}
	external_labels = {}
}
